{% extends "base.html" %}

{% block title %}Organization Hierarchy - Employee Feedback Portal{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/hierarchy-tree.css') }}">
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-sitemap me-2"></i>Organization Hierarchy
    </h2>
    <div class="btn-group">
        <button type="button" class="btn btn-outline-primary" onclick="expandAll()">
            <i class="fas fa-expand-arrows-alt me-1"></i>Expand All
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="collapseAll()">
            <i class="fas fa-compress-arrows-alt me-1"></i>Collapse All
        </button>
    </div>
</div>

<!-- Access Level Banner -->
<div class="alert alert-info mb-4">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h6 class="mb-1">
                <i class="fas fa-info-circle me-2"></i>
                {% if access_level == 'full' %}
                    Full Organization View - You can see the complete organizational hierarchy
                {% elif access_level == 'manager' %}
                    Manager View - You can see your team and all subordinates ({{ stats.user_subordinates }} employees)
                {% else %}
                    Employee View - You can see yourself, your manager, and your immediate peers
                {% endif %}
            </h6>
            <small class="text-muted">
                Showing {{ stats.total_employees }} employees with {{ stats.total_managers }} managers across {{ stats.max_depth }} levels
            </small>
        </div>
        <div class="col-md-4 text-end">
            {% if current_user.is_manager %}
            <span class="badge bg-primary">Manager Access</span>
            {% else %}
            <span class="badge bg-secondary">Employee Access</span>
            {% endif %}
        </div>
    </div>
</div>

<!-- Hierarchy Overview Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center border-primary">
            <div class="card-body">
                <h4 class="text-primary mb-1">{{ stats.total_managers }}</h4>
                <p class="mb-0 text-muted">Total Managers</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-success">
            <div class="card-body">
                <h4 class="text-success mb-1">{{ stats.total_employees }}</h4>
                <p class="mb-0 text-muted">Total Employees</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-warning">
            <div class="card-body">
                <h4 class="text-warning mb-1">{{ stats.max_depth }}</h4>
                <p class="mb-0 text-muted">Hierarchy Levels</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-info">
            <div class="card-body">
                <h4 class="text-info mb-1">{{ stats.user_subordinates if current_user.is_manager else 0 }}</h4>
                <p class="mb-0 text-muted">Your Team Size</p>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filter -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-end">
            <div class="col-md-4">
                <label for="searchHierarchy" class="form-label">Search Employee</label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" class="form-control" id="searchHierarchy" 
                           placeholder="Search by name, designation, or employee ID...">
                </div>
            </div>
            <div class="col-md-2">
                <label for="filterTeam" class="form-label">Team</label>
                <select class="form-select" id="filterTeam">
                    <option value="">All Teams</option>
                    <option value="UFS">UFS</option>
                    <option value="RG">RG</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="filterLocation" class="form-label">Location</label>
                <select class="form-select" id="filterLocation">
                    <option value="">All Locations</option>
                    <option value="Bangalore">Bangalore</option>
                    <option value="Mumbai">Mumbai</option>
                    <option value="Delhi">Delhi</option>
                    <option value="Hyderabad">Hyderabad</option>
                    <option value="Chennai">Chennai</option>
                    <option value="Pune">Pune</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="filterManager" class="form-label">Manager</label>
                <input type="text" class="form-control" id="filterManager" 
                       placeholder="Manager name...">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-outline-secondary w-100" onclick="clearHierarchyFilters()">
                    <i class="fas fa-times me-1"></i>Clear
                </button>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-primary w-100" onclick="highlightPath()">
                    <i class="fas fa-route me-1"></i>Show Path
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Organization Tree Structure -->
{% if top_managers %}
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-sitemap me-2"></i>Organization Tree Structure
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="org-tree" id="organizationTree">
            {{ render_org_tree(top_managers, current_user) }}
        </div>
    </div>
</div>

<!-- Legend -->
<div class="card mt-4">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-info-circle me-2"></i>Organization Hierarchy Legend
        </h6>
    </div>
    <div class="card-body">
        <div class="hierarchy-legend">
            <div class="row">
                <div class="col-md-3">
                    <div class="legend-item">
                        <div class="legend-color legend-ceo"></div>
                        <span>CEO/Director Level</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="legend-item">
                        <div class="legend-color legend-manager"></div>
                        <span>Line Managers</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="legend-item">
                        <div class="legend-color legend-employee"></div>
                        <span>Team Members</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="legend-item">
                        <div class="legend-color legend-current"></div>
                        <span>Your Position</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="card">
    <div class="card-body">
        <div class="empty-hierarchy">
            <i class="fas fa-sitemap"></i>
            <h4>No Organization Structure Found</h4>
            <p>No organizational hierarchy data is available for your access level.</p>
            {% if current_user.is_manager %}
            <a href="{{ url_for('import_excel') }}" class="btn btn-primary">
                <i class="fas fa-file-excel me-1"></i>Import Employee Data
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- Employee Detail Modal -->
<div class="modal fade" id="employeeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user me-2"></i>Employee Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="employeeDetails">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editEmployeeBtn">
                    <i class="fas fa-edit me-1"></i>Edit Employee
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!-- Macro for rendering organization chart structure -->
{% macro render_org_tree(top_managers, current_user) %}
    <!-- Level 0: Executive Level (CEO/Director) -->
    {% for ceo in top_managers %}
        {% if ceo.hierarchy_level <= 1 or not ceo.manager_id %}
        <div class="tree-level level-0">
            <div class="chart-level-header level-0">Executive Level</div>
            {{ render_employee_node(ceo, 'ceo', current_user) }}
        </div>
        
        <!-- Level 1: Management Level (Line Managers) -->
        {% set line_managers = ceo.direct_reports | selectattr('is_manager', 'equalto', true) | list %}
        {% if line_managers %}
        <div class="tree-level level-1">
            <div class="chart-level-header level-1">Management Level</div>
            {% for manager in line_managers %}
            <div class="manager-group">
                <div class="manager-node">
                    {{ render_employee_node(manager, 'manager', current_user) }}
                </div>
                
                <!-- Level 2: Employee Level (Team Members) -->
                {% set reportees = manager.direct_reports | reject('equalto', none) | list %}
                {% if reportees %}
                <div class="reportees">
                    {% for employee in reportees %}
                        {{ render_employee_node(employee, 'employee', current_user) }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- Level 2 Header for Employee Level -->
        {% if line_managers and line_managers|selectattr('direct_reports')|list %}
        <div class="chart-level-header level-2" style="top: calc(100% - 120px);">Employee Level</div>
        {% endif %}
        
        <!-- Direct reportees of CEO (if any) -->
        {% set ceo_direct_employees = ceo.direct_reports | rejectattr('is_manager', 'equalto', true) | list %}
        {% if ceo_direct_employees %}
        <div class="tree-level level-1">
            <div class="manager-group">
                <div class="reportees">
                    {% for employee in ceo_direct_employees %}
                        {{ render_employee_node(employee, 'employee', current_user) }}
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        {% endif %}
    {% endfor %}
{% endmacro %}

<!-- Macro for rendering individual employee nodes -->
{% macro render_employee_node(employee, node_type, current_user) %}
<div class="employee-node" data-employee-id="{{ employee.id }}">
    <div class="employee-card {{ node_type }}-card {{ 'current-user' if employee.id == current_user.id else '' }}" 
         onclick="showEmployeeDetails({{ employee.id }})">
        
        <div class="employee-avatar {{ node_type }}-avatar">
            {{ employee.full_name[:2].upper() if employee.full_name else 'NA' }}
        </div>
        
        <div class="employee-name">{{ employee.full_name or 'N/A' }}</div>
        
        <div class="employee-title">{{ employee.designation or employee.role or 'Employee' }}</div>
        
        <div class="employee-details">
            {% if node_type == 'ceo' %}
                <span class="employee-badge badge-ceo">CEO/Director</span>
            {% elif node_type == 'manager' %}
                <span class="employee-badge badge-manager">Manager</span>
            {% else %}
                <span class="employee-badge badge-employee">Employee</span>
            {% endif %}
            
            {% if employee.team %}
                <span class="employee-badge badge-team">{{ employee.team }}</span>
            {% endif %}
            
            <div class="mt-2">
                <small>{{ employee.system_id or employee.bensl_id or 'N/A' }}</small>
            </div>
            
            {% if employee.location %}
            <div class="mt-1">
                <small><i class="fas fa-map-marker-alt"></i> {{ employee.location }}</small>
            </div>
            {% endif %}
            
            {% if employee.direct_reports %}
            <div class="mt-1">
                <small><i class="fas fa-users"></i> {{ employee.direct_reports|length }} reports</small>
            </div>
            {% endif %}
        </div>
        
        {% if current_user.can_manage(employee) or current_user.id == employee.id %}
        <div class="employee-actions">
            <button type="button" class="action-btn" onclick="event.stopPropagation(); editEmployee({{ employee.id }})" title="Edit">
                <i class="fas fa-edit"></i>
            </button>
            <button type="button" class="action-btn" onclick="event.stopPropagation(); viewEmployee({{ employee.id }})" title="View Details">
                <i class="fas fa-eye"></i>
            </button>
        </div>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% block scripts %}
<script>
    let hierarchyData = {};

    document.addEventListener('DOMContentLoaded', function() {
        initializeHierarchy();
        setupHierarchyFilters();
    });

    function initializeHierarchy() {
        console.log('Hierarchy initialized');
        // Add any initialization logic here
    }

    function setupHierarchyFilters() {
        const searchHierarchy = document.getElementById('searchHierarchy');
        const filterTeam = document.getElementById('filterTeam');
        const filterLocation = document.getElementById('filterLocation');
        const filterManager = document.getElementById('filterManager');

        if (searchHierarchy) searchHierarchy.addEventListener('input', filterHierarchy);
        if (filterTeam) filterTeam.addEventListener('change', filterHierarchy);
        if (filterLocation) filterLocation.addEventListener('change', filterHierarchy);
        if (filterManager) filterManager.addEventListener('input', filterHierarchy);
    }

    function filterHierarchy() {
        const searchTerm = document.getElementById('searchHierarchy').value.toLowerCase();
        const teamFilter = document.getElementById('filterTeam').value;
        const locationFilter = document.getElementById('filterLocation').value;
        const managerFilter = document.getElementById('filterManager').value.toLowerCase();

        const employeeNodes = document.querySelectorAll('.employee-node');
        
        employeeNodes.forEach(node => {
            const employeeName = node.querySelector('.employee-name').textContent.toLowerCase();
            const employeeTeam = node.querySelector('.badge-team')?.textContent || '';
            const employeeLocation = node.textContent.toLowerCase();
            
            let visible = true;
            
            if (searchTerm && !employeeName.includes(searchTerm)) {
                visible = false;
            }
            
            if (teamFilter && employeeTeam !== teamFilter) {
                visible = false;
            }
            
            if (locationFilter && !employeeLocation.includes(locationFilter.toLowerCase())) {
                visible = false;
            }
            
            if (managerFilter && !employeeLocation.includes(managerFilter)) {
                visible = false;
            }
            
            node.style.display = visible ? 'block' : 'none';
        });
    }

    function clearHierarchyFilters() {
        document.getElementById('searchHierarchy').value = '';
        document.getElementById('filterTeam').value = '';
        document.getElementById('filterLocation').value = '';
        document.getElementById('filterManager').value = '';
        
        const employeeNodes = document.querySelectorAll('.employee-node');
        employeeNodes.forEach(node => {
            node.style.display = 'block';
        });
    }

    function expandAll() {
        // No collapsing in tree view, but we can highlight all connections
        console.log('Expand all hierarchy');
    }

    function collapseAll() {
        // No collapsing in tree view
        console.log('Collapse all hierarchy');
    }

    function showEmployeeDetails(employeeId) {
        // Load employee details in modal
        fetch(`/api/employee/${employeeId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error loading employee details: ' + data.error);
                    return;
                }
                
                const modalContent = `
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <div class="employee-avatar ceo-avatar mb-3" style="width: 80px; height: 80px; font-size: 24px; margin: 0 auto;">
                                ${data.full_name ? data.full_name.substring(0, 2).toUpperCase() : 'NA'}
                            </div>
                            <h5>${data.full_name || 'N/A'}</h5>
                            <p class="text-muted">${data.designation || data.role || 'Employee'}</p>
                        </div>
                        <div class="col-md-8">
                            <table class="table table-sm">
                                <tr><td><strong>Employee ID:</strong></td><td>${data.system_id || data.bensl_id || 'N/A'}</td></tr>
                                <tr><td><strong>Email:</strong></td><td>${data.emailid || 'N/A'}</td></tr>
                                <tr><td><strong>Team:</strong></td><td>${data.team || 'N/A'}</td></tr>
                                <tr><td><strong>Location:</strong></td><td>${data.location || 'N/A'}</td></tr>
                                <tr><td><strong>Grade:</strong></td><td>${data.grade || 'N/A'}</td></tr>
                                <tr><td><strong>Employment Type:</strong></td><td>${data.employment_type || 'N/A'}</td></tr>
                                <tr><td><strong>Status:</strong></td><td>${data.employee_status || 'N/A'}</td></tr>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('employeeDetails').innerHTML = modalContent;
                document.getElementById('editEmployeeBtn').onclick = () => editEmployee(employeeId);
                
                const modal = new bootstrap.Modal(document.getElementById('employeeModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading employee details');
            });
    }

    function editEmployee(employeeId) {
        window.location.href = `/employee/edit/${employeeId}`;
    }

    function viewEmployee(employeeId) {
        showEmployeeDetails(employeeId);
    }
</script>
{% endblock %}nager) filterManager.addEventListener('input', filterHierarchy);
    }

    function toggleSubtree(button) {
        const orgNode = button.closest('.org-node');
        const subtree = orgNode.querySelector('.subtree');
        const icon = button.querySelector('i');

        if (subtree.style.display === 'none') {
            subtree.style.display = 'block';
            icon.className = 'fas fa-minus';
            hierarchyData.expandedNodes.add(orgNode.dataset.employeeId);
        } else {
            subtree.style.display = 'none';
            icon.className = 'fas fa-plus';
            hierarchyData.expandedNodes.delete(orgNode.dataset.employeeId);
        }
    }

    function expandAll() {
        const subtrees = document.querySelectorAll('.subtree');
        const buttons = document.querySelectorAll('.expand-btn i');

        subtrees.forEach(subtree => subtree.style.display = 'block');
        buttons.forEach(icon => icon.className = 'fas fa-minus');

        document.querySelectorAll('.org-node').forEach(item => {
            hierarchyData.expandedNodes.add(item.dataset.employeeId);
        });
    }

    function collapseAll() {
        const subtrees = document.querySelectorAll('.subtree');
        const buttons = document.querySelectorAll('.expand-btn i');

        subtrees.forEach(subtree => subtree.style.display = 'none');
        buttons.forEach(icon => icon.className = 'fas fa-plus');

        hierarchyData.expandedNodes.clear();
    }

    function filterHierarchy() {
        const searchTerm = document.getElementById('searchHierarchy').value.toLowerCase();
        const teamFilter = document.getElementById('filterTeam').value;
        const locationFilter = document.getElementById('filterLocation').value;
        const managerFilter = document.getElementById('filterManager').value.toLowerCase();

        const orgNodes = document.querySelectorAll('.org-node');

        orgNodes.forEach(node => {
            const name = node.dataset.name;
            const designation = node.dataset.designation;
            const team = node.dataset.team;
            const location = node.dataset.location;

            // Get manager name from the org-box content
            const managerElement = node.querySelector('.org-box-details');
            const managerText = managerElement ? managerElement.textContent.toLowerCase() : '';

            const matchesSearch = !searchTerm || 
                                name.includes(searchTerm) || 
                                designation.includes(searchTerm);
            const matchesTeam = !teamFilter || team === teamFilter;
            const matchesLocation = !locationFilter || location === locationFilter;
            const matchesManager = !managerFilter || managerText.includes(managerFilter);

            const shouldShow = matchesSearch && matchesTeam && matchesLocation && matchesManager;

            if (shouldShow) {
                node.style.display = 'block';
                showParentPath(node);
            } else {
                node.style.display = 'none';
            }
        });
    }

    function showParentPath(node) {
        let parent = node.parentElement;
        while (parent && !parent.classList.contains('hierarchy-container')) {
            if (parent.classList.contains('org-node')) {
                parent.style.display = 'block';
            }
            parent = parent.parentElement;
        }
    }

    function clearHierarchyFilters() {
        document.getElementById('searchHierarchy').value = '';
        document.getElementById('filterTeam').value = '';
        document.getElementById('filterLocation').value = '';
        document.getElementById('filterManager').value = '';

        document.querySelectorAll('.org-node').forEach(node => {
            node.style.display = 'block';
        });
    }

    function highlightPath() {
        const searchTerm = document.getElementById('searchHierarchy').value.toLowerCase();
        if (!searchTerm) {
            alert('Please enter a search term to highlight the path');
            return;
        }

        document.querySelectorAll('.highlighted-path').forEach(el => {
            el.classList.remove('highlighted-path');
        });

        const orgNodes = document.querySelectorAll('.org-node');
        orgNodes.forEach(node => {
            const name = node.dataset.name;
            const designation = node.dataset.designation;

            if (name.includes(searchTerm) || designation.includes(searchTerm)) {
                highlightEmployeePath(node);
            }
        });
    }

    function highlightEmployeePath(node) {
        node.classList.add('highlighted-path');

        let parent = node.parentElement;
        while (parent && !parent.classList.contains('hierarchy-container')) {
            if (parent.classList.contains('org-node')) {
                parent.classList.add('highlighted-path');
            }
            parent = parent.parentElement;
        }
    }

    function showEmployeeDetails(employeeId) {
        const modal = new bootstrap.Modal(document.getElementById('employeeModal'));
        document.getElementById('employeeDetails').innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading employee details...</p>
            </div>
        `;

        document.getElementById('editEmployeeBtn').onclick = () => editEmployee(employeeId);
        modal.show();

        fetch(`/api/employee/${employeeId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                document.getElementById('employeeDetails').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Basic Information</h6>
                            <p><strong>Name:</strong> ${data.full_name || 'N/A'}</p>
                            <p><strong>System ID:</strong> ${data.system_id || 'N/A'}</p>
                            <p><strong>Email:</strong> ${data.emailid || 'N/A'}</p>
                            <p><strong>Gender:</strong> ${data.gender || 'N/A'}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Work Details</h6>
                            <p><strong>Designation:</strong> ${data.designation || 'N/A'}</p>
                            <p><strong>Team:</strong> ${data.team || 'N/A'}</p>
                            <p><strong>Location:</strong> ${data.location || 'N/A'}</p>
                            <p><strong>Employment Type:</strong> ${data.employment_type || 'N/A'}</p>
                        </div>
                    </div>
                    <hr>
                    <h6>Additional Information</h6>
                    <p><strong>Manager:</strong> ${data.manager_name || 'N/A'}</p>
                    <p><strong>Skills:</strong> ${data.skill || 'N/A'}</p>
                    <p><strong>Billing Rate:</strong> ${data.billing_rate ? '$' + data.billing_rate : 'N/A'}</p>
                `;
            })
            .catch(error => {
                document.getElementById('employeeDetails').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading employee details: ${error.message}
                    </div>
                `;
            });
    }

    function editEmployee(employeeId) {
        window.location.href = `{{ url_for('edit_employee', id=0) }}`.replace('0', employeeId);
    }
</script>

<style>
    .hierarchy-container {
        min-height: 500px;
        padding: 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
        overflow-x: auto;
        display: flex;
        flex-direction: row;
        align-items: flex-start;
        gap: 40px;
    }

    .hierarchy-level {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 250px;
    }

    .manager-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }

    .org-node {
        position: relative;
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .manager-node {
        margin-bottom: 30px;
    }

    .leaf-node {
        margin-bottom: 10px;
    }

    .org-box {
        width: 220px;
        min-height: 120px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 10px;
        position: relative;
        overflow: hidden;
    }

    .org-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    /* Level-based colors */
    .org-box.level-0 {
        background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
        color: white;
        border: 2px solid #2c5aa0;
    }

    .org-box.level-1 {
        background: linear-gradient(135deg, #5cb85c 0%, #449d44 100%);
        color: white;
        border: 2px solid #357a35;
    }

    .org-box.level-2 {
        background: linear-gradient(135deg, #f0ad4e 0%, #ec971f 100%);
        color: white;
        border: 2px solid #d58512;
    }

    .org-box.level-3 {
        background: linear-gradient(135deg, #d9534f 0%, #c9302c 100%);
        color: white;
        border: 2px solid #ac2925;
    }

    .org-box.level-4 {
        background: linear-gradient(135deg, #c39bd3 0%, #a569bd 100%);
        color: white;
        border: 2px solid #8e44ad;
    }

    .org-box.current-user {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important;
        border: 3px solid #ff6b6b !important;
        animation: pulse-glow 2s infinite;
    }

    @keyframes pulse-glow {
        0% { box-shadow: 0 4px 8px rgba(0,0,0,0.1), 0 0 0 0 rgba(255, 107, 107, 0.7); }
        50% { box-shadow: 0 6px 12px rgba(0,0,0,0.15), 0 0 0 10px rgba(255, 107, 107, 0); }
        100% { box-shadow: 0 4px 8px rgba(0,0,0,0.1), 0 0 0 0 rgba(255, 107, 107, 0); }
    }

    .org-box-header {
        padding: 10px 15px;
        background: rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        font-size: 14px;
    }

    .org-box-body {
        padding: 15px;
    }

    .org-box-title {
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 13px;
    }

    .org-box-details {
        font-size: 12px;
        opacity: 0.9;
    }

    .org-box-details .badge {
        font-size: 10px;
        padding: 2px 6px;
    }

    .expand-control {
        position: relative;
        margin-top: 10px;
        z-index: 10;
    }

    .expand-btn {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border: 2px solid #007bff;
        color: #007bff;
    }

    .expand-btn:hover {
        background: #007bff;
        color: white;
    }

    .direct-reports-container {
        margin-top: 20px;
        width: 100%;
        border-left: 2px solid #007bff;
        padding-left: 20px;
        position: relative;
    }

    .direct-reports-container::before {
        content: '';
        position: absolute;
        left: -2px;
        top: -20px;
        width: 22px;
        height: 2px;
        background-color: #007bff;
    }

    .direct-reports-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .direct-report-item {
        position: relative;
    }

    .direct-report-item::before {
        content: '';
        position: absolute;
        left: -22px;
        top: 60px;
        width: 20px;
        height: 2px;
        background-color: #007bff;
    }

    .subtree {
        width: 100%;
    }

    .highlighted-path {
        animation: highlight-pulse 2s infinite;
    }

    @keyframes highlight-pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    /* Legend styles */
    .org-box.level-0:not(.hierarchy-container .org-box) {
        width: 40px;
        height: 20px;
        min-height: unset;
        margin: 0;
        cursor: default;
    }

    .org-box.level-1:not(.hierarchy-container .org-box) {
        width: 40px;
        height: 20px;
        min-height: unset;
        margin: 0;
        cursor: default;
    }

    .org-box.level-2:not(.hierarchy-container .org-box) {
        width: 40px;
        height: 20px;
        min-height: unset;
        margin: 0;
        cursor: default;
    }

    .org-box.level-3:not(.hierarchy-container .org-box) {
        width: 40px;
        height: 20px;
        min-height: unset;
        margin: 0;
        cursor: default;
    }

    .org-box.level-4:not(.hierarchy-container .org-box) {
        width: 40px;
        height: 20px;
        min-height: unset;
        margin: 0;
        cursor: default;
    }

    .org-box.current-user:not(.hierarchy-container .org-box) {
        width: 40px;
        height: 20px;
        min-height: unset;
        margin: 0;
        cursor: default;
        animation: none;
    }

    @media (max-width: 768px) {
        .hierarchy-container {
            flex-direction: column;
            gap: 20px;
        }

        .hierarchy-level {
            min-width: 100%;
        }

        .org-box {
            width: 180px;
            min-height: 100px;
        }

        .org-box-header {
            padding: 8px 12px;
            font-size: 12px;
        }

        .org-box-body {
            padding: 12px;
        }

        .org-box-title {
            font-size: 11px;
        }

        .org-box-details {
            font-size: 10px;
        }
    }
</style>
{% endblock %}