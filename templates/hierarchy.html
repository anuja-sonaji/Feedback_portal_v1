{% extends "base.html" %}

{% block title %}Organization Hierarchy - Employee Feedback Portal{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/hierarchy-tree.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-sitemap me-2"></i>Organization Hierarchy
                </h2>
                <div class="btn-group">
                    {% if current_user.is_manager %}
                    <a href="{{ url_for('import_excel') }}" class="btn btn-primary">
                        <i class="fas fa-file-excel me-1"></i>Import Data
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="card-title mb-0">
                <i class="fas fa-filter me-2"></i>Filters & Search
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="searchHierarchy">Search Employee</label>
                        <input type="text" id="searchHierarchy" class="form-control" 
                               placeholder="Search by name or designation...">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label for="filterTeam">Team</label>
                        <select id="filterTeam" class="form-select">
                            <option value="">All Teams</option>
                            {% for team in stats.teams %}
                            <option value="{{ team }}">{{ team }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label for="filterLocation">Location</label>
                        <select id="filterLocation" class="form-select">
                            <option value="">All Locations</option>
                            {% for location in stats.locations %}
                            <option value="{{ location }}">{{ location }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="filterManager">Manager</label>
                        <input type="text" id="filterManager" class="form-control" 
                               placeholder="Search by manager name...">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <div class="d-grid">
                            <button type="button" class="btn btn-outline-secondary" onclick="clearHierarchyFilters()">
                                <i class="fas fa-times me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    {% if stats %}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary">{{ stats.total_employees }}</h3>
                    <p class="card-text">Total Employees</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success">{{ stats.total_managers }}</h3>
                    <p class="card-text">Managers</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info">{{ stats.hierarchy_depth }}</h3>
                    <p class="card-text">Hierarchy Levels</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning">{{ access_level }}</h3>
                    <p class="card-text">Your Access Level</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Organization Tree Structure -->
    {% if top_managers %}
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-sitemap me-2"></i>Organization Tree Structure
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="org-tree" id="organizationTree">
                {{ render_org_tree(top_managers, current_user) }}
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="card mt-4">
        <div class="card-header">
            <h6 class="card-title mb-0">
                <i class="fas fa-info-circle me-2"></i>Organization Hierarchy Legend
            </h6>
        </div>
        <div class="card-body">
            <div class="hierarchy-legend">
                <div class="row">
                    <div class="col-md-3">
                        <div class="legend-item">
                            <div class="legend-color legend-ceo"></div>
                            <span>CEO/Director Level</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="legend-item">
                            <div class="legend-color legend-manager"></div>
                            <span>Line Managers</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="legend-item">
                            <div class="legend-color legend-employee"></div>
                            <span>Team Members</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="legend-item">
                            <div class="legend-color legend-current"></div>
                            <span>Your Position</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <div class="card">
        <div class="card-body">
            <div class="empty-hierarchy">
                <i class="fas fa-sitemap"></i>
                <h4>No Organization Structure Found</h4>
                <p>No organizational hierarchy data is available for your access level.</p>
                {% if current_user.is_manager %}
                <a href="{{ url_for('import_excel') }}" class="btn btn-primary">
                    <i class="fas fa-file-excel me-1"></i>Import Employee Data
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Employee Details Modal -->
<div class="modal fade" id="employeeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Employee Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="employeeDetails">
                <!-- Employee details loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editEmployeeBtn">Edit Employee</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!-- Macro for rendering organization chart structure -->
{% macro render_org_tree(top_managers, current_user) %}
    <!-- Level 0: Executive Level (CEO/Director) -->
    {% for ceo in top_managers %}
        {% if ceo.hierarchy_level <= 1 or not ceo.manager_id %}
        <div class="tree-level level-0">
            <div class="chart-level-header level-0">Executive Level</div>
            {{ render_employee_node(ceo, 'ceo', current_user) }}
        </div>
        
        <!-- Level 1: Management Level (Line Managers) -->
        {% set line_managers = ceo.direct_reports | selectattr('is_manager', 'equalto', true) | list %}
        {% if line_managers %}
        <div class="tree-level level-1">
            <div class="chart-level-header level-1">Management Level</div>
            {% for manager in line_managers %}
            <div class="manager-group">
                <div class="manager-node">
                    {{ render_employee_node(manager, 'manager', current_user) }}
                </div>
                
                <!-- Level 2: Employee Level (Team Members) -->
                {% set reportees = manager.direct_reports | reject('equalto', none) | list %}
                {% if reportees %}
                <div class="reportees">
                    {% for employee in reportees %}
                        {{ render_employee_node(employee, 'employee', current_user) }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- Level 2 Header for Employee Level -->
        {% if line_managers and line_managers|selectattr('direct_reports')|list %}
        <div class="chart-level-header level-2" style="top: calc(100% - 120px);">Employee Level</div>
        {% endif %}
        
        <!-- Direct reportees of CEO (if any) -->
        {% set ceo_direct_employees = ceo.direct_reports | rejectattr('is_manager', 'equalto', true) | list %}
        {% if ceo_direct_employees %}
        <div class="tree-level level-1">
            <div class="manager-group">
                <div class="reportees">
                    {% for employee in ceo_direct_employees %}
                        {{ render_employee_node(employee, 'employee', current_user) }}
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        {% endif %}
    {% endfor %}
{% endmacro %}

<!-- Macro for rendering individual employee nodes -->
{% macro render_employee_node(employee, node_type, current_user) %}
<div class="employee-node" data-employee-id="{{ employee.id }}">
    <div class="employee-card {{ node_type }}-card {{ 'current-user' if employee.id == current_user.id else '' }}" 
         onclick="showEmployeeDetails({{ employee.id }})">
        
        <div class="employee-avatar {{ node_type }}-avatar">
            {{ employee.full_name[:2].upper() if employee.full_name else 'NA' }}
        </div>
        
        <div class="employee-name">{{ employee.full_name or 'N/A' }}</div>
        
        <div class="employee-title">{{ employee.designation or employee.role or 'Employee' }}</div>
        
        <div class="employee-details">
            {% if node_type == 'ceo' %}
                <span class="employee-badge badge-ceo">CEO/Director</span>
            {% elif node_type == 'manager' %}
                <span class="employee-badge badge-manager">Manager</span>
            {% else %}
                <span class="employee-badge badge-employee">Employee</span>
            {% endif %}
            
            {% if employee.team %}
                <span class="employee-badge badge-team">{{ employee.team }}</span>
            {% endif %}
            
            <div class="mt-2">
                <small>{{ employee.system_id or employee.bensl_id or 'N/A' }}</small>
            </div>
            
            {% if employee.location %}
            <div class="mt-1">
                <small><i class="fas fa-map-marker-alt"></i> {{ employee.location }}</small>
            </div>
            {% endif %}
            
            {% if employee.direct_reports %}
            <div class="mt-1">
                <small><i class="fas fa-users"></i> {{ employee.direct_reports|length }} reports</small>
            </div>
            {% endif %}
        </div>
        
        {% if current_user.can_manage(employee) or current_user.id == employee.id %}
        <div class="employee-actions">
            <button type="button" class="action-btn" onclick="event.stopPropagation(); editEmployee({{ employee.id }})" title="Edit">
                <i class="fas fa-edit"></i>
            </button>
            <button type="button" class="action-btn" onclick="event.stopPropagation(); viewEmployee({{ employee.id }})" title="View Details">
                <i class="fas fa-eye"></i>
            </button>
        </div>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initializeHierarchy();
        setupHierarchyFilters();
    });

    function initializeHierarchy() {
        console.log('Hierarchy initialized');
    }

    function setupHierarchyFilters() {
        const searchHierarchy = document.getElementById('searchHierarchy');
        const filterTeam = document.getElementById('filterTeam');
        const filterLocation = document.getElementById('filterLocation');
        const filterManager = document.getElementById('filterManager');

        if (searchHierarchy) searchHierarchy.addEventListener('input', filterHierarchy);
        if (filterTeam) filterTeam.addEventListener('change', filterHierarchy);
        if (filterLocation) filterLocation.addEventListener('change', filterHierarchy);
        if (filterManager) filterManager.addEventListener('input', filterHierarchy);
    }

    function filterHierarchy() {
        const searchTerm = document.getElementById('searchHierarchy').value.toLowerCase();
        const teamFilter = document.getElementById('filterTeam').value;
        const locationFilter = document.getElementById('filterLocation').value;
        const managerFilter = document.getElementById('filterManager').value.toLowerCase();

        const employeeNodes = document.querySelectorAll('.employee-node');
        
        employeeNodes.forEach(node => {
            const employeeName = node.querySelector('.employee-name').textContent.toLowerCase();
            const employeeTeam = node.querySelector('.badge-team')?.textContent || '';
            const employeeLocation = node.textContent.toLowerCase();
            
            let visible = true;
            
            if (searchTerm && !employeeName.includes(searchTerm)) {
                visible = false;
            }
            
            if (teamFilter && employeeTeam !== teamFilter) {
                visible = false;
            }
            
            if (locationFilter && !employeeLocation.includes(locationFilter.toLowerCase())) {
                visible = false;
            }
            
            if (managerFilter && !employeeLocation.includes(managerFilter)) {
                visible = false;
            }
            
            node.style.display = visible ? 'block' : 'none';
        });
    }

    function clearHierarchyFilters() {
        document.getElementById('searchHierarchy').value = '';
        document.getElementById('filterTeam').value = '';
        document.getElementById('filterLocation').value = '';
        document.getElementById('filterManager').value = '';
        
        const employeeNodes = document.querySelectorAll('.employee-node');
        employeeNodes.forEach(node => {
            node.style.display = 'block';
        });
    }

    function showEmployeeDetails(employeeId) {
        fetch(`/api/employee/${employeeId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error loading employee details: ' + data.error);
                    return;
                }
                
                const modalContent = `
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <div class="employee-avatar ceo-avatar mb-3" style="width: 80px; height: 80px; font-size: 24px; margin: 0 auto;">
                                ${data.full_name ? data.full_name.substring(0, 2).toUpperCase() : 'NA'}
                            </div>
                            <h5>${data.full_name || 'N/A'}</h5>
                            <p class="text-muted">${data.designation || data.role || 'Employee'}</p>
                        </div>
                        <div class="col-md-8">
                            <table class="table table-sm">
                                <tr><td><strong>Employee ID:</strong></td><td>${data.system_id || data.bensl_id || 'N/A'}</td></tr>
                                <tr><td><strong>Email:</strong></td><td>${data.emailid || 'N/A'}</td></tr>
                                <tr><td><strong>Team:</strong></td><td>${data.team || 'N/A'}</td></tr>
                                <tr><td><strong>Location:</strong></td><td>${data.location || 'N/A'}</td></tr>
                                <tr><td><strong>Grade:</strong></td><td>${data.grade || 'N/A'}</td></tr>
                                <tr><td><strong>Employment Type:</strong></td><td>${data.employment_type || 'N/A'}</td></tr>
                                <tr><td><strong>Status:</strong></td><td>${data.employee_status || 'N/A'}</td></tr>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('employeeDetails').innerHTML = modalContent;
                document.getElementById('editEmployeeBtn').onclick = () => editEmployee(employeeId);
                
                const modal = new bootstrap.Modal(document.getElementById('employeeModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading employee details');
            });
    }

    function editEmployee(employeeId) {
        window.location.href = `/employee/edit/${employeeId}`;
    }

    function viewEmployee(employeeId) {
        showEmployeeDetails(employeeId);
    }
</script>
{% endblock %}